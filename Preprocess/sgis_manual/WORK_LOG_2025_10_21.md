# Work Log: SGIS Data Integration for Airbnb Model
**Date:** October 21, 2025
**Objective:** Integrate Korean census data from SGIS API to enhance Airbnb prediction model

---

## ğŸ“‹ Today's Work Summary

### 1. Initial Setup and Testing (âœ… COMPLETED)

**What we did:**
- Set up SGIS API client with authentication
- Created test scripts to validate API connectivity
- Successfully authenticated and obtained access tokens
- Confirmed API credentials are working

**Files created:**
- `sgis_api_client.py` - Core API client with authentication
- `test_collection.py` - Test script for small sample collection
- `diagnose_api.py` - Diagnostic tool for API inspection
- `find_correct_code_format.py` - Code format testing script

**Key Finding:**
- âœ… API authentication works correctly
- âœ… Access tokens valid for 4 hours
- âœ… API calls successful with proper credentials

---

### 2. Administrative Code Format Discovery (âœ… RESOLVED)

**Problem:**
- CSV file contains 7-digit dong codes (e.g., `1101053`)
- SGIS API requires 8-digit codes (e.g., `11010530`)
- Initial attempts failed with "í–‰ì •êµ¬ì—­ ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”" error

**Solution:**
- Discovered API needs 8-digit format (7-digit + trailing "0")
- Fixed code conversion in `sgis_api_client.py`:
```python
seoul_dongs['dong_code'] = seoul_dongs['dong_code_7digit'].astype(int).astype(str) + '0'
```
- Issue: Float values (e.g., `1101053.0`) were being converted to `"1101053.00"` instead of `"11010530"`
- Fix: Convert to int first to remove decimal, then append "0"

**Status:** âœ… RESOLVED - All 426 Seoul dong codes now properly formatted

---

### 3. API Capabilities Investigation (âœ… COMPLETED)

**APIs Tested:**

#### âœ… Household/Housing API (`/OpenAPI3/stats/household.json`)
- **Status:** Working perfectly
- **Returns:**
  - `household_cnt` - Number of households
  - `avg_family_member_cnt` - Average family size
  - `family_member_cnt` - Total family members
- **Granularity:** Enumeration district level (more detailed than dong)
- **Test Results:** Successfully collected 312 records (5 dongs Ã— 2 years)

#### âœ… Company API (`/OpenAPI3/stats/company.json`)
- **Status:** Working, but LIMITED
- **Returns:**
  - `corp_cnt` - Total company count (aggregate only)
  - `tot_worker` - Total workers (aggregate only)
- **Limitation:** âŒ NO industry-specific breakdowns
- **Test Results:** Successfully collected 196 records (3 dongs Ã— 2 years)

#### âŒ Industry Code API (`/OpenAPI3/stats/industrycode.json`)
- **Status:** Returns 412 Precondition Failed
- **Impact:** Not critical - we have static code tables

#### âŒ Business Distribution API (`/OpenAPI3/*/corpdistsummary.json`)
- **Status:** Returns 404 Not Found
- **Tested Endpoints:**
  - `/OpenAPI3/stats/corpdistsummary.json`
  - `/OpenAPI3/analysis/corpdistsummary.json`
  - `/OpenAPI3/lifebiz/corpdistsummary.json`
- **Conclusion:** This API may not be available through OpenAPI3, or requires different authentication

---

### 4. Critical Discovery: API Limitations (âš ï¸ IMPORTANT)

**Finding:** The SGIS OpenAPI **cannot provide industry-specific business counts**

**Evidence:**
1. Reviewed official SGIS manual PDF (`(ì°¸ê³ 1) SGIS ì†Œì§€ì—­ í†µê³„ ì´ìš©ë§¤ë‰´ì–¼.pdf`)
2. Manual confirms two separate systems:
   - **OpenAPI** - Returns aggregate statistics only
   - **Web Portal + SDC** - Provides detailed industry breakdowns via custom requests

3. Industry codes (`cp2_bnu_55`, `cp2_bnu_56`) are **column names in downloaded CSV files**, not API parameters

**What this means:**
- âœ… Can collect: Housing units, total companies, total workers
- âŒ Cannot collect via API: Accommodation counts, restaurant counts, retail counts
- Alternative: Manual data request through SGIS web portal

---

### 5. Files Created Today

#### Core Implementation
- âœ… `sgis_api_client.py` - API client with all collectors
- âœ… `collect_sgis_data.py` - Original collection script (needs update)
- âœ… `collect_sgis_data_v2.py` - Updated script for aggregate data
- âœ… `preprocess_sgis_data.py` - Preprocessing pipeline (yearly to monthly)

#### Testing & Diagnostics
- âœ… `test_collection.py` - Validates API with sample dongs
- âœ… `diagnose_api.py` - Raw API response inspector
- âœ… `find_correct_code_format.py` - Code format tester
- âœ… `test_industry_params.py` - Industry parameter testing
- âœ… `explore_industry_endpoints.py` - Alternative endpoint search
- âœ… `test_business_distribution_api.py` - Business distribution API test

#### Documentation
- âœ… `README.md` - Complete usage guide
- âœ… `API_LIMITATIONS_AND_NEXT_STEPS.md` - Detailed analysis of limitations
- âœ… `WORK_LOG_2025_10_21.md` - This document

---

### 6. Test Results

**Successful Test Collection:**
```
Test Suite Results:
- Authentication: âœ… Success
- Industry Codes: âŒ 412 error (not critical)
- Household Data: âœ… 312 records collected (5 dongs Ã— 2 years)
  - Records per dong-year: 5-54 (enumeration districts)
- Company Data: âœ… 196 records collected (3 dongs Ã— 2 years)
  - Aggregate counts only (no industry breakdown)

Duration: 1.03 seconds
Output: test_output/test_household_data.csv, test_output/test_company_data.csv
```

**Sample Data Structure:**

Household Data:
```csv
household_cnt,avg_family_member_cnt,family_member_cnt,adm_cd,year,dong_name,gu_name
231,2.8,646,11230510,2020,ì‹ ì‚¬ë™,Gangnam-gu
```

Company Data:
```csv
corp_cnt,tot_worker,adm_cd,year,dong_name,gu_name
21,280,11230510,2020,ì‹ ì‚¬ë™,Gangnam-gu
```

---

## ğŸ¯ Current Status

### What Works
1. âœ… API authentication and token management
2. âœ… Housing/household data collection
3. âœ… Aggregate company data collection
4. âœ… Code format conversion (7-digit â†’ 8-digit)
5. âœ… Collection pipeline ready for all 426 Seoul dongs
6. âœ… Preprocessing pipeline designed (yearly â†’ monthly interpolation)

### What Doesn't Work
1. âŒ Industry-specific business counts via API
2. âŒ Business distribution API (404 errors)
3. âŒ Industry code API (412 errors)

### Outstanding Questions
1. â“ Is there an alternative API endpoint for industry ratios?
2. â“ Should we proceed with aggregate data or request manual data?
3. â“ How important is industry-specific data vs. aggregate for model performance?

---

## ğŸ“Š Three Options Moving Forward

### Option 1: Use Aggregate Company Data (QUICKEST)

**Collect via API:**
- Housing units (residential supply)
- Total company counts (commercial activity)
- Total worker counts (employment level)

**Timeline:** Can run immediately (~30-45 minutes)

**Pros:**
- Fully automated
- Still provides economic activity indicators
- Reasonable proxies for tourist attractiveness

**Cons:**
- No separation of accommodations/restaurants/retail
- Less specific than originally planned

**Next Steps:**
```bash
python collect_sgis_data_v2.py --years 2017 2018 2019 2020 2021 2022 2023
```

---

### Option 2: Manual Web Portal Request (MOST ACCURATE)

**Process:**
1. Visit SGIS portal: https://sgis.kostat.go.kr/
2. Navigate to "ìë£Œì œê³µ" (Data Service)
3. Request custom data for:
   - `cp2_bnu_55` (ìˆ™ë°•ì—… - Accommodations)
   - `cp2_bnu_56` (ìŒì‹ì  ë° ì£¼ì ì—… - Restaurants/Bars)
   - `cp2_bnu_47` (ì†Œë§¤ì—… - Retail, if needed)
4. Specify: Seoul, 2017-2023, dong level
5. Wait 1-2 business days for data file

**Timeline:** 1-2 days + integration time

**Pros:**
- Exact industry-specific data you wanted
- Official SGIS data with full detail
- Best for research validity

**Cons:**
- Manual process, not automated
- Takes 1-2 days to receive
- One-time download (hard to update)

---

### Option 3: Alternative API Exploration (INVESTIGATIVE)

**User's Suggestion:** Business Distribution Summary API
- URL mentioned: https://sgis.kostat.go.kr/developer/html/newOpenApi/api/dataApi/lifeBizStatsMap.html#corpdistsummary
- Business codes: https://sgis.kostat.go.kr/developer/html/openApi/api/dataCode/ThemeCode.html

**Status:** Tested, returned 404 errors

**Possible Reasons:**
1. API may not be available through OpenAPI3 interface
2. May require different authentication method
3. May be part of web visualization service, not data API
4. Documentation may be outdated

**Next Investigation Steps:**
1. Contact SGIS support to confirm API availability
2. Check if there's an API key/permission needed for this endpoint
3. Look for alternative endpoints that provide industry ratios
4. Review complete API documentation for hidden endpoints

---

## ğŸ“ Recommendation

### My Assessment

**For immediate progress:** Option 1 (aggregate data)
- Ready to run now
- Methodologically sound (aggregate business density is used in urban economics)
- You can always supplement with manual data later if needed

**For best data quality:** Option 2 (manual request)
- Worth doing if you have 1-2 days
- Most accurate for your original research question
- Can compare model performance with/without industry-specific data

**For exploring alternatives:** Option 3 (continue API investigation)
- Low success probability based on today's testing
- Would require SGIS support contact
- Time-consuming with uncertain outcome

### Suggested Hybrid Approach

1. **Immediate (Today/Tomorrow):**
   - Run Option 1 collection (aggregate data)
   - Start model training with available data

2. **Parallel (This week):**
   - Submit manual data request (Option 2)
   - Test model with aggregate features

3. **When manual data arrives:**
   - Compare model performance: aggregate vs. industry-specific
   - Publish results showing both approaches

This gives you:
- âœ… Immediate progress
- âœ… Best quality data (eventually)
- âœ… Comparison analysis for your paper

---

## ğŸ”„ Next Steps

### Immediate Next Steps (Ready to Execute)

#### If Choosing Option 1 (Aggregate Data):

**Step 1: Full Data Collection** (~30-45 minutes)
```bash
cd "C:\Users\jour\Documents\GitHub\airbnb\Preprocess\sgis_manual"

# Run collection for all 426 Seoul dongs, 7 years
python collect_sgis_data_v2.py \
  --years 2017 2018 2019 2020 2021 2022 2023 \
  --output-dir ./collected_data \
  --rate-limit 0.5
```

Expected outputs:
- `collected_data/housing_data_raw.csv` (~5,964 rows: 426 dongs Ã— 7 years Ã— 2 avg records)
- `collected_data/company_data_raw.csv` (~5,964 rows)
- `collected_data/collection_summary.txt`

**Step 2: Preprocess to Monthly** (~5 minutes)
```bash
python preprocess_sgis_data.py \
  --input-dir ./collected_data \
  --output-dir ../../Data/Preprocessed_data/Dong \
  --reference-data ../../Data/Preprocessed_data/AirBnB_labels_dong.csv \
  --start-month 2017-07 \
  --end-month 2023-01
```

Expected outputs:
- `SGIS_housing_units_monthly.csv` (426 dongs Ã— 67 months = 28,542 rows)
- `SGIS_company_counts_monthly.csv` (426 dongs Ã— 67 months = 28,542 rows)
- `SGIS_combined_embedding.csv` (combined features)
- `SGIS_embedding_aligned.csv` (ready for model)

**Step 3: Update Model Configuration**

Edit `Model/main.py`:
```python
embedding_paths_dict = {
    'road': '../Data/Preprocessed_data/Dong/Road_Embeddings_with_flow.csv',
    'hf': '../Data/Preprocessed_data/Dong/Human_flow.csv',
    'raw': '../Data/Preprocessed_data/Dong/AirBnB_raw_embedding.csv',
    'llm_w': '../Data/Preprocessed_data/Dong/llm_embeddings_new/Airbnb_SSP_w.csv',
    'llm_wo': '../Data/Preprocessed_data/Dong/llm_embeddings_new/Airbnb_SSP_wo.csv',
    'road_llm': '../Data/Preprocessed_data/Dong/llm_embeddings_new/road_llm.csv',
    'hf_llm': '../Data/Preprocessed_data/Dong/llm_embeddings_new/human_flow_llm.csv',
    'sgis': '../Data/Preprocessed_data/Dong/SGIS_embedding_aligned.csv'  # NEW!
}
```

**Step 4: Train and Evaluate**
```bash
cd ../Model

# Test with SGIS embedding
python main.py --embed1 road_llm --embed2 hf_llm --embed3 sgis --model lstm --window_size 6

# Compare baseline (without SGIS)
python main.py --embed1 road_llm --embed2 hf_llm --embed3 llm_w --model lstm --window_size 6
```

---

#### If Choosing Option 2 (Manual Request):

**Step 1: Submit Data Request**
1. Visit: https://sgis.kostat.go.kr/
2. Register/login with your account
3. Navigate to: ìë£Œì œê³µ â†’ ë§ì¶¤ í†µê³„ ìƒì„± (Custom Statistics)
4. Fill request form:
   - Region: ì„œìš¸íŠ¹ë³„ì‹œ (Seoul)
   - Level: ìë©´ë™ (Dong level)
   - Years: 2017, 2018, 2019, 2020, 2021, 2022, 2023
   - Variables requested:
     - `cp2_bnu_55` - ìˆ™ë°•ì—… (Accommodation businesses)
     - `cp2_bnu_56` - ìŒì‹ì  ë° ì£¼ì ì—… (Restaurants and bars)
     - `cp2_bnu_47` - ì†Œë§¤ì—… (Retail stores) - if available
   - Purpose: Academic research (í•™ìˆ  ì—°êµ¬)

5. Submit and wait for approval email

**Step 2: While Waiting**
- Run Option 1 collection in parallel
- Start model training with aggregate data
- Prepare integration code for manual data

**Step 3: When Data Arrives**
- I'll help you integrate the manual data
- Compare model performance: aggregate vs. industry-specific
- Analyze which features contribute most

---

#### If Choosing Option 3 (Continue Investigation):

**Step 1: Contact SGIS Support**
- Email: sgis@kostat.go.kr (or check website for contact)
- Questions to ask:
  1. Is the Business Distribution Summary API (`corpdistsummary`) available through OpenAPI3?
  2. If yes, what is the correct endpoint and authentication method?
  3. If no, is there an alternative API for industry ratios/distributions?
  4. Are there any undocumented endpoints for industry-specific data?

**Step 2: Review Complete API Documentation**
- Check if there's a comprehensive API specification document
- Look for swagger/OpenAPI specification
- Search for any beta/experimental endpoints

**Step 3: Test Alternative Approaches**
- Try different base URLs
- Test with different authentication parameters
- Check if there's a v2 or v4 API

---

## ğŸ“‚ File Structure Summary

```
airbnb/Preprocess/sgis_manual/
â”œâ”€â”€ README.md                                           # Complete usage guide
â”œâ”€â”€ API_LIMITATIONS_AND_NEXT_STEPS.md                 # Detailed analysis
â”œâ”€â”€ WORK_LOG_2025_10_21.md                            # This document
â”‚
â”œâ”€â”€ sgis_api_client.py                                # âœ… Core API client
â”œâ”€â”€ collect_sgis_data.py                              # âš ï¸  Old version
â”œâ”€â”€ collect_sgis_data_v2.py                           # âœ… Updated for aggregate data
â”œâ”€â”€ preprocess_sgis_data.py                           # âœ… Preprocessing pipeline
â”‚
â”œâ”€â”€ test_collection.py                                # âœ… Test script (working)
â”œâ”€â”€ diagnose_api.py                                   # âœ… Diagnostic tool
â”œâ”€â”€ find_correct_code_format.py                       # âœ… Code format tester
â”œâ”€â”€ test_industry_params.py                           # Test for industry params
â”œâ”€â”€ explore_industry_endpoints.py                     # Alternative endpoint search
â”œâ”€â”€ test_business_distribution_api.py                 # Business dist. API test
â”‚
â”œâ”€â”€ í•œêµ­í–‰ì •êµ¬ì—­ë¶„ë¥˜_í–‰ì •ë™ì½”ë“œ(7ìë¦¬)_20210701ê¸°ì¤€_extracted.csv   # Dong codes
â”‚
â”œâ”€â”€ ref_code/
â”‚   â”œâ”€â”€ (ì°¸ê³ 1) SGIS ì†Œì§€ì—­ í†µê³„ ì´ìš©ë§¤ë‰´ì–¼.pdf        # Official manual
â”‚   â”œâ”€â”€ (ì°¸ê³ 2) SGIS ì†Œì§€ì—­ í†µê³„ ë¶„ì„ì‚¬ë¡€ì§‘.pdf        # Usage examples
â”‚   â”œâ”€â”€ adm_code.xls                                  # Administrative codes
â”‚   â””â”€â”€ statistics_code.xls                           # Industry codes
â”‚
â”œâ”€â”€ test_output/                                       # Test results
â”‚   â”œâ”€â”€ test_household_data.csv                       # âœ… 312 records
â”‚   â””â”€â”€ test_company_data.csv                         # âœ… 196 records
â”‚
â””â”€â”€ collected_data/                                    # Will be created
    â”œâ”€â”€ housing_data_raw.csv                          # To be generated
    â”œâ”€â”€ company_data_raw.csv                          # To be generated
    â””â”€â”€ collection_summary.txt                        # To be generated
```

---

## â° Time Estimates

### Option 1 Timeline
- Data collection: 30-45 minutes
- Preprocessing: 5 minutes
- Model update: 10 minutes
- Training/testing: 1-2 hours
- **Total: ~3 hours to first results**

### Option 2 Timeline
- Request submission: 30 minutes
- Waiting period: 1-2 business days
- Data integration: 1 hour
- Training/testing: 1-2 hours
- **Total: 2-3 days to final results**

### Option 3 Timeline
- Support contact: 1 day
- Response wait: 2-5 business days
- Implementation (if successful): 2-3 hours
- **Total: 3-7 days, uncertain outcome**

---

## ğŸ¤” Decision Point

**Please decide which option to pursue:**

1. **Option 1 - Aggregate Data** â†’ I'll run the collection immediately
2. **Option 2 - Manual Request** â†’ I'll guide you through the web portal submission
3. **Option 3 - More Investigation** â†’ I'll draft a support email to SGIS
4. **Hybrid Approach** â†’ Run Option 1 now + submit Option 2 request in parallel

**What would you like to do?**

---

## ğŸ“§ Questions & Clarifications Needed

1. **Urgency:** Do you need results this week, or is 1-2 weeks acceptable?

2. **Research Validity:** For your paper, is it more important to have:
   - Quick results with aggregate data?
   - Slower but more specific industry data?

3. **Comparison Analysis:** Are you interested in comparing model performance with different data granularities (aggregate vs. industry-specific)?

4. **Time Investment:** How much time can you spend on manual processes vs. automated pipelines?

---

## ğŸ’¡ My Personal Recommendation

Based on today's work, I recommend:

**Immediate Action: Option 1**
- Run the collection script tonight/tomorrow
- You'll have working features in ~3 hours
- Start seeing model improvements quickly

**Parallel Action: Option 2**
- Submit the manual request tomorrow
- Takes 5 minutes to submit
- Arrives in 1-2 days while you're training models

**Result:**
- You get two versions: aggregate and industry-specific
- Can compare both in your paper
- Demonstrates robustness of your approach
- Provides richer analysis

This gives you the best of both worlds with minimal risk!

---

## ğŸ“Œ Summary

**Today's Achievements:**
- âœ… API setup and authentication working
- âœ… Fixed critical code format bug
- âœ… Confirmed data collection pipeline works
- âœ… Identified API limitations clearly
- âœ… Created comprehensive documentation
- âœ… Tested 312 household + 196 company records successfully

**Ready to Execute:**
- Collection script for all 426 dongs Ã— 7 years
- Preprocessing pipeline (yearly â†’ monthly)
- Model integration instructions

**Your Decision Needed:**
- Which option to pursue (1, 2, 3, or hybrid)?
- Timeline preferences
- Research priority (speed vs. specificity)

---

**Last Updated:** October 21, 2025, 02:35 AM KST
**Status:** âœ… Ready for data collection - awaiting user decision
**Next Session:** Run full collection or submit manual request based on user choice
